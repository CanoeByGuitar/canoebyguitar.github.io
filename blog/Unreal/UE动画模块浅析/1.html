<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">UE动画模块浅析 | Chenhui</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://canoebyguitar.github.io/blog/Unreal/UE动画模块浅析/1"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="UE动画模块浅析 | Chenhui"><meta data-rh="true" name="description" content="动画融合方式"><meta data-rh="true" property="og:description" content="动画融合方式"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-07-07T18:07:01.000Z"><meta data-rh="true" property="article:tag" content="UE"><link data-rh="true" rel="icon" href="/img/avatar.ico"><link data-rh="true" rel="canonical" href="https://canoebyguitar.github.io/blog/Unreal/UE动画模块浅析/1"><link data-rh="true" rel="alternate" href="https://canoebyguitar.github.io/blog/Unreal/UE动画模块浅析/1" hreflang="en"><link data-rh="true" rel="alternate" href="https://canoebyguitar.github.io/blog/Unreal/UE动画模块浅析/1" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Chenhui RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Chenhui Atom Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.8a001723.css">
<link rel="preload" href="/assets/js/runtime~main.aa064b75.js" as="script">
<link rel="preload" href="/assets/js/main.bbe150d2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ 如果这个网站能帮助到你，欢迎给一个star支持作者  <a target="_blank" rel="noopener noreferrer" href="https://github.com/canoeByGuitar">GitHub</a></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">MainPage</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Notebooks</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/canoeByGuitar" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/设计模式/1">常用设计模式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/模版元范式入门/1">模版元入门</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/动态多态和静态多态/1">动态多态和静态多态</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Unreal/UE_Cookbook/1">UE C++ Cookbook</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/Modern Cpp新特性总结/1">Modern Cpp新特性总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/仿函数/1">仿函数和std::function</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Unreal/RewindDebugger/1">Rewind Debugger</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/cpp规范">C++ 规范（自用）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Unreal/Factory">解析UE用于创建资源的类 -- Factory</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/项目/Code-Graph/CodeGraph">Code Graph</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/项目/Maya-Physion-Bone/PhysionBone">伪物理实时弹性骨骼</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/项目/Pose-Space-Deformer/PoseDriverDeformer">全流程Pose Driver Deformer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Unreal/Lyra浅析/1">Lyra浅析</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/Unreal/UE动画模块浅析/1">UE动画模块浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Unreal/UE类型系统/1">UE类型系统</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/杂谈/浅析ECS架构/ECS">浅析ECS架构</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/Cpp和UE智能指针详解/1">Cpp和UE智能指针详解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/从移动语义到封装RAII类/1">从移动语义到封装RAII类</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/编译和链接/链接、装载与库">编译和链接</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/项目/CAD课程作业：物理引擎/PhysicEngine">项目/CAD课程作业：物理引擎/PhysicEngine</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/杂谈/三种操作系统开发环境的搭建/Linux问题汇总">三种操作系统开发环境的搭建</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Rendering/渲染基础 - Fundamental of Graphics/1">渲染基础 - Fundamental of Graphics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/C++/面向对象基础/1">入门：C++面向对象</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/数据结构和算法/RBTree/RBTree">红黑树</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/数据结构和算法/Dijkstra/Dijkstra">Djikstra题型总结</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">UE动画模块浅析</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-07-07T18:07:01.000Z" itemprop="datePublished">July 7, 2024</time> · <!-- -->19 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h1>UE动画常用操作</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="动画融合方式">动画融合方式<a href="#动画融合方式" class="hash-link" aria-label="Direct link to 动画融合方式" title="Direct link to 动画融合方式">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="传统动画融合">传统动画融合<a href="#传统动画融合" class="hash-link" aria-label="Direct link to 传统动画融合" title="Direct link to 传统动画融合">​</a></h3><p><img loading="lazy" alt="alt text" src="/assets/images/image-25-e99ef8ffb8cf0cce49152f3a1fb94a4f.png" width="644" height="292" class="img_ev3q"></p><p>Blend那一段需要计算两端动画以及他们的混合，相当于双倍的动画开销</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="惯性融合inertialization">惯性融合Inertialization<a href="#惯性融合inertialization" class="hash-link" aria-label="Direct link to 惯性融合Inertialization" title="Direct link to 惯性融合Inertialization">​</a></h3><ul><li>现实里不会混合（挥手后放下，而不会边挥手边放下）</li><li>不进行blend，而是后处理解决不连续性</li></ul><p><img loading="lazy" alt="alt text" src="/assets/images/image-24-7decd9052becb5c7afd9f8a802e70ca4.png" width="646" height="95" class="img_ev3q"></p><p>下面的曲线，是sequence1 - sequence2， 要做的工作是把他们的差值缓慢消除</p><p>插值成关于t的五次函数，参数由fade-off时间、两端序列首位的位置差和速度差 控制</p><p><img loading="lazy" alt="alt text" src="/assets/images/image-26-260520fb8e38e015a5b51f6389b83471.png" width="651" height="253" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="additive动画">Additive动画<a href="#additive动画" class="hash-link" aria-label="Direct link to Additive动画" title="Direct link to Additive动画">​</a></h2><p>用来对Base Pose叠加一些额外的效果，比如运动状态受击的轻微反馈、瞄准状态开枪后的后坐力效果。
<img loading="lazy" alt="alt text" src="/assets/images/image-e26da75b8fa249c5a234745a39d6f9fd.png" width="873" height="415" class="img_ev3q">
设Base Pose的Transform矩阵为B（所有joint），Reference Pose为R，Additive Pose（这里指被减数那个Pose）为A，那么Final Pose <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>R</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>A</mi><mo stretchy="false">)</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">F = (R^{-1}A)B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span></span></p><p>下图1为BasePose，Addtive Pose为向上瞄准，图2采用Local Space Additive，把Addtive Pose基于父骨骼的Transform叠加到Base Pose的父骨骼上，会导致瞄准歪掉，不再是预期的正上方。而图3采用Mesh Space Additive，把Addtive Pose基于root的Transform叠加到父骨骼上,这里会进行一次坐标系转换：Transform矩阵从Mesh Space =&gt; Local Space,因此开销比较大。
<img loading="lazy" alt="alt text" src="/assets/images/image-1-4af299a734c05696c670c8e35f8a04ad.png" width="995" height="592" class="img_ev3q"></p><p> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>R</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mi>A</mi><mo stretchy="false">)</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">F = (R^{-1}A)B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.13889em">F</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span></span>在UE中的实现如下</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// FAnimationRuntime::AccumulateLocalSpaceAdditivePoseInternal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 这里的RTS都是BasePose的成员变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Rotation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VectorQuaternionMultiply2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlendedRotation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Rotation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Translation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VectorMultiplyAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Atom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Translation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BlendWeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Translation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scale3D </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VectorMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Scale3D</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VectorMultiplyAdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Atom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Scale3D</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BlendWeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DefaultScale</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Mesh Space的话会有额外两步
<img loading="lazy" alt="alt text" src="/assets/images/image-2-81150ac18cc7d6cc32f8281e29f3a21d.png" width="1224" height="263" class="img_ev3q">
这里可以看出Mesh Space就是Root的Space,对于一条骨骼链，local space的rotation分别为R0,R1,R2, 那么Orientation2 = R0 <em> R1 </em> R2(想象机械臂从末端向root依次旋转)</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FCompactPoseBoneIndex </span><span class="token function" style="color:#d73a49">BoneIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> BoneIndex </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> LocalPose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetNumBones</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">BoneIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FCompactPoseBoneIndex ParentIndex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LocalPose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetParentBoneIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BoneIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FQuat MeshSpaceRotation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LocalPose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ParentIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> LocalPose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BoneIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LocalPose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BoneIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MeshSpaceRotation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里注意,ue的FMatrix是<a href="https://mobile.rodolphe-vaillant.fr/entry/145/unreal-engine-c-tmap-doc-sheet-1" target="_blank" rel="noopener noreferrer">row-matrix需要右乘</a>，但TQuat是左乘。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="animation-montage">Animation Montage<a href="#animation-montage" class="hash-link" aria-label="Direct link to Animation Montage" title="Direct link to Animation Montage">​</a></h2><p>用来把多个AnimSequence合在一起根据game逻辑按任意顺序进行播放，一些基本的概念：</p><ul><li>Section: 把时间轴分为多个section，每个section可以放一段Sequence，可以根据逻辑切换播放每一段section，也可以设置section之间的混入</li><li>Slot/Slot Group: Slot可以覆盖一个mesh或一个子mesh（比如FullBody/UpperBody），Slot在蒙太奇内设置，可以包含一些AnimSequence，设置好slot后就可以在ABP中使用，如下图，Slot节点在触发播放前会使用Source，比如Locomotion，而在触发后（比如角色按特定键）会override source动画。
<img loading="lazy" alt="alt text" src="/assets/images/image-17-4c13de0d2aed7772303e323cc813091d.png" width="1590" height="576" class="img_ev3q">
上图中，FullBody slot可以进行表情，而UpperBody可以放手部动画比如换弹。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="重定向">重定向<a href="#重定向" class="hash-link" aria-label="Direct link to 重定向" title="Direct link to 重定向">​</a></h2><p>Sequence A的Skeleton是S1， 把Sequence A应用到Skeleton S2上，要解决两点：</p><ol><li>建立骨骼对应关系：骨骼名称不同 / 骨骼数量不同 / 骨骼长度不同</li><li>S1的初始Pose和S2的初始Pose可能不同（比如一个A-Pose 另一个T-Pose），因此某一帧动画，调整到同一Pose所需要的transform是不同的。</li></ol><h1>源码剖析</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="资产类">资产类<a href="#资产类" class="hash-link" aria-label="Direct link to 资产类" title="Direct link to 资产类">​</a></h2><div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> UObject o-- UAnimationAsset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimationAsset o--  UAnimationSequeceBase </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimationAsset   o-- UBlendSpaceBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimationAsset : USkeleton *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> UAnimationSequeceBase o--  UAnimCompositeBase </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimationSequeceBase  o-- UAnimSequence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimCompositeBase  o-- UAnimComposite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UAnimCompositeBase  o-- UAnimMontage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="导入过程">导入过程<a href="#导入过程" class="hash-link" aria-label="Direct link to 导入过程" title="Direct link to 导入过程">​</a></h3><p>FBX导入后一般会出现这几个资产</p><p><img loading="lazy" alt="alt text" src="/assets/images/image-18-d6c04aefc9794228630115ee16da8d4c.png" width="358" height="181" class="img_ev3q"></p><p>接下来的解析通过UFbxFactory::FactoryCreateFile来断点调试</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USkeletalMesh</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> BaseSkeletalMesh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseSkeletalMesh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FbxImporter</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">ImportSkeletalMesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> ImportSkeletalMeshArgs </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USkeletalMesh</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> UnFbx</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">FFbxImporter</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">ImportSkeletalMesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FImportSkeletalMeshArgs </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ImportSkeletalMeshArgs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 导入的fbx中的所有数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FSkeletalMeshImportData</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> SkelMeshImportDataPtr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">FillSkeletalMeshImportData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SkelMeshImportDataPtr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 最终要输出的skeletalmesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    USkeletalMesh</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> SkeletalMesh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 写入USkeletalMesh的RefSkeleton成员</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">SkeletalMeshImportUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">ProcessImportMeshSkeleton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> SkeletalMesh</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetRefSkeleton</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">SkelMeshImportDataPtr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 写入LOD蒙皮数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FSkeletalMeshBuildParameters </span><span class="token function" style="color:#d73a49">SkeletalMeshBuildParameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SkeletalMesh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetTargetPlatformManagerRef</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRunningTargetPlatform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ImportLODModelIndex</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bRegenDepLODs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bBuildSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MeshBuilderModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BuildSkeletalMesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SkeletalMeshBuildParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>写入USkeletalMesh的RefSkeleton</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TArray </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">SkeletalMeshImportData</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FBone</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> RefBonesBinary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ImportData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RefBonesBinary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RefSkeleton</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 用FReferenceSkeletonModifier对RefSkeleton作出修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FReferenceSkeletonModifier </span><span class="token function" style="color:#d73a49">RefSkelModifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RefSkeleton</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SkeletonAsset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int32 b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> RefBonesBinary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> SkeletalMeshImportData</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FBone </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> BinaryBone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RefBonesBinary</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FString BoneName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">FSkeletalMeshImportData</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">FixupBoneName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BinaryBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 骨骼结构，静态存储的树以及对应的transform</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FMeshBoneInfo </span><span class="token function" style="color:#d73a49">BoneInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">FName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">BoneName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FNAME_Add</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BinaryBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BinaryBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ParentIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FTransform </span><span class="token function" style="color:#d73a49">BoneTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BinaryBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BonePos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RefSkelModifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BoneInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BoneTransform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>写入LOD蒙皮数据</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Engine/Source/Developer/MeshBuilder/Private/SkeletalMeshBuilder.cpp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 把LOD Mesh数据存入 USkeletalMesh.ImportedModel;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMeshLODModel</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> BuildLODModel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SkeletalMesh</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetImportedModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">LODModels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">LODIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MeshUtilities</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BuildSkeletalMesh</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BuildLODModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SkeletalMesh</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetPathName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RefSkeleton</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LODInfluences</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LODWedges</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LODFaces</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LODPoints</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LODPointToRawMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Options</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uskeleton">USkeleton<a href="#uskeleton" class="hash-link" aria-label="Direct link to USkeleton" title="Direct link to USkeleton">​</a></h3><p>USkeleton是UAnimationAsset的成员</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">USkeleton</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">UPROPERTY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">VisibleAnywhere</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Category</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Skeleton</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FBoneNode</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> BoneTree</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FReferenceSkeleton ReferenceSkeleton</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">USkeletalMeshSocket</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Sockets</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> FName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FReferencePose </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> AnimRetargetSources</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// FSmartNameContainer由两个map组成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// NameMapings: {FName : {[{CurveFName0, MetaData0}, {CurveFName1, MetaData1}, ... , {CurveFNameN, MetaDataN}]}}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// LoadedMappings：{FName : {[{CurveFName0, MetaData0}, {CurveFName1, MetaData1}, ... , {CurveFNameN, MetaDataN}]}}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSmartNameContainer SmartNames</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 用来在SkeletalMesh中挂载其他mesh，比如武器。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 没有这个的话就只能在Actor的SkeletalMeshComponent下attach武器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">USkeletalMeshSocket</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FName SocketName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FName BoneName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FVector RelativeLocation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FRotator RelativeRotation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FVector RelativeScale</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bonetree">BoneTree<a href="#bonetree" class="hash-link" aria-label="Direct link to BoneTree" title="Direct link to BoneTree">​</a></h4><p><img loading="lazy" alt="alt text" src="/assets/images/image-19-b0a0a68a059de3636e18b10c9eddb546.png" width="1187" height="233" class="img_ev3q"></p><p>似乎不会使用，都是空的，具体得看一下导入fbx的流程有没有使用到这个</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="freferenceskeleton">FReferenceSkeleton<a href="#freferenceskeleton" class="hash-link" aria-label="Direct link to FReferenceSkeleton" title="Direct link to FReferenceSkeleton">​</a></h4><p><img loading="lazy" alt="alt text" src="/assets/images/image-20-17fdf3fbbeb07a1b815e87ee155672ec.png" width="1190" height="268" class="img_ev3q"></p><p>存储</p><ul><li>原始的骨骼数据</li><li>加入了用户自定义virtual bone的全部骨骼数据</li></ul><p>所有的骨骼用TArray静态存储树的结构，同时维护一个Name到Index的Map</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FMeshBoneInfo</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FName Name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 ParentIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// root的parentindex是NoneIndex(-1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FReferenceSkeleton</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// raw data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FMeshBoneInfo</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   RawRefBoneInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FTransform</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">      RawRefBonePose</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// raw data + virtual bone data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FMeshBoneInfo</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   FinalRefBoneInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FTransform</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">      FinalRefBonePose</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** TMap to look up bone index from bone name. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> int32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">      RawNameToIndexMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TMap</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> int32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">      FinalNameToIndexMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fsmartnamecnntainer">FSmartNameCnntainer<a href="#fsmartnamecnntainer" class="hash-link" aria-label="Direct link to FSmartNameCnntainer" title="Direct link to FSmartNameCnntainer">​</a></h4><p>可以自定义的属性，本身含有曲线属性</p><p><img loading="lazy" alt="alt text" src="/assets/images/image-21-f35d6a2e40ecd90bcd470619b4b822bc.png" width="1189" height="161" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="skeletalmesh">SkeletalMesh<a href="#skeletalmesh" class="hash-link" aria-label="Direct link to SkeletalMesh" title="Direct link to SkeletalMesh">​</a></h3><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SkeletalMesh</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// editor-only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TSharedPtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSkeletalMeshModel</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ImportedModel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// runtime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 下面分析了FSkeletalMeshModel， TODO 分析SkeletalMeshRenderData</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TUniquePtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSkeletalMeshRenderData</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> SkeletalMeshRenderData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USkeleton</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Skeleton</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FBoxSphereBounds ImportedBounds</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSkeletalMaterial</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Materials</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UPhysicsAsset</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> PhysicsAsset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">classDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMesh  *--   FSkeletalMeshModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMeshModel *-- FSkeletalMeshLODModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMeshLODModel *-- FSkelMeshSection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkelMeshSection *-- FSoftSkinVertex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMesh : TSharedPtr&lt; FSkeletalMeshModel &gt; ImportedModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMesh : USkeleton *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMeshModel : TArray &lt; FSkeletalMeshLODModel&gt; Sections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkeletalMeshLODModel: TArray &lt; FSkelMeshSection &gt; Sections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSkelMeshSection : TArray&lt; FSoftSkinVertex &gt; SoftVertices</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FVector Position</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FVector TangentX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FVector TangentY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FVector TangentZ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FVector2D UVs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSoftSkinVertex : FColor Color</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Skeletal Mesh渲染的模式<a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/skeletal-mesh-rendering-paths-in-unreal-engine" target="_blank" rel="noopener noreferrer">https://dev.epicgames.com/documentation/en-us/unreal-engine/skeletal-mesh-rendering-paths-in-unreal-engine</a></p><p>在某一个LOD层，同一Material的Mesh称为一个Section，如果一个Section依赖太多骨骼，会通过一些几何算法进一步拆分成多个Chunk。</p><p>Chunk只会在运行时生成，和Section共用同一个数据结构</p><p><img loading="lazy" alt="alt text" src="/assets/images/image-22-7cc1426048a437a98dadae1d9a845bce.png" width="1194" height="490" class="img_ev3q"></p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FSkeletalMeshModel</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// TIndirectArray 和TArray差不多，但堆里面存储的是指向元素的指针，可以避免resize的时候memcopy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TIndirectArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSkeletalMeshLODModel</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> LODModels</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// FSkeletamMeshLODModel 对应某层LOD的skeletal mesh数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FSkeletalMeshLODModel</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSkelMeshSection</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Sections</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// SkelMeshSection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 这是使用同一material的子mesh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 也可能是Bone Chunking技术构造的子mesh，用于并行加速</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FSkelMeshSection</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> MaterialIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> BaseIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 相对于Sections首地址的偏移值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> BaseVertexIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 顶点的offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> NumTriangles</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 所有顶点的具体信息，包括Position，TBN向量， UV坐标， FColor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FSoftSkinVertex</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> SoftVertices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 这一section用到的所有骨骼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FBoneIndexType</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> BoneMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * If this section was produce because of BONE chunking, the parent section index will be valid.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * If the section is not the result of skin vertex chunking, this value will be INDEX_NONE.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Use this value to know if the section was BONE chunked:</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * if(ChunkedParentSectionIndex != INDEX_NONE) will be true if the section is BONE chunked</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 ChunkedParentSectionIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uanimationsequence">UAnimationSequence<a href="#uanimationsequence" class="hash-link" aria-label="Direct link to UAnimationSequence" title="Direct link to UAnimationSequence">​</a></h3><p>UAnimSequenceBase中已经有了sequence所需要的核心数据和属性</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UAnimSequenceBase</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="color:#00009f">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">UAnimationAsset</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 按时间先后排序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FAnimNotifyEvent</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Notifies</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> SequenceLength</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> RateScale</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> bLoop</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// sequecen数据，包括骨骼动画数据和curve，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// AnimSequence的instance会在运行时从DataModel中拿数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TObjectPtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">UAnimDataModel</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> DataModel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UAnimDataModel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="color:#00009f">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">UObject</span><span class="token base-clause punctuation" style="color:#393A34">,</span><span class="token base-clause"> </span><span class="token base-clause keyword" style="color:#00009f">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">IAnimationDataModel</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FBoneAnimationTrack</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> BoneAnimationTracks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FFrameRate FrameRate</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 动画采样的帧率</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 NumberOfFrames</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 采样总帧数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 NumberOfKeys</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 关键帧总数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FAnimationCurveData CurveData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">//曲线数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 一个track就对应一个bone的transform曲线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FBoneAnimationTrack</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int32 BoneTreeIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FName Name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    FRawAnimSequenceTrack：</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    TArray&lt;FVector3f&gt; PosKeys;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    TArray&lt;FQuat4f&gt; RotKeys;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    TArray&lt;FVector3f&gt; ScaleKeys;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FRawAnimSequenceTrack InternalTrackData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FAnimationCurveData</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FFloatCurve</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> FloatCurves</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// FFloatCurve 就是TArray保存的time/value（float）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FTransformCurve</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> TransformCurves</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// FTransformCurve 就是TArray保存的time/transform value（float3）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>UAnimSequence定义了些额外的的属性，如动画压缩、插值方式等</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UAnimSequence</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause keyword" style="color:#00009f">public</span><span class="token base-clause"> </span><span class="token base-clause class-name">UAnimSequenceBase</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 动画压缩配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TObjectPtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UAnimBoneCompressionSettings</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> BoneCompressionSettings；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TObjectPtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UAnimCurveCompressionSettings</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> CurveCompressionSettings</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 被压缩后的数据，压缩的方法无非就是</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 1. 线性插值造成的误差（这个误差一般是体现在mesh上的，比如绑两个点，计算替换前后这两个点的compnent space location）在一定threshold内的，只保留首位帧</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 2. 对数据进行压缩，比如float扩大多少倍后压缩成int8/int16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCompressedAnimSequence CompressedData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Additive动画</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEnumAsByte</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token class-name">EAdditiveAnimationType</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> AdditiveAnimType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// local space / mesh space</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Retargeting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FName RetargetSource</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//重定向的Base Pose</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 插值方式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EAnimInterpolationType Interpolation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// linear / step（用更近的那个key的值）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// RootMotion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> bEnableRootMotion</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uaniminstance和faniminstanceproxy">UAnimInstance和FAnimInstanceProxy<a href="#uaniminstance和faniminstanceproxy" class="hash-link" aria-label="Direct link to UAnimInstance和FAnimInstanceProxy" title="Direct link to UAnimInstance和FAnimInstanceProxy">​</a></h2><p>UAnimInstance是动画蓝图的父类，每个实例化的character拥有一个AnimInstance实例。通过AnimGraph封装动画流程，通过EventGraph或其他手段（比如BlueprintThreadsafeUpdate Function， 重写NativeThreadSafeUpdateAnimation等）和Actor的其他组件交互（比如移动组件）。</p><p>强依赖于FAnimInstanceProxy，FAnimInstanceProxy一般不止运行在工作线程。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UAnimInstance</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TObjectPtr</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">USkeleton</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> CurrentSkeleton</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 允许AnimInstance将native update, blend tree, montages 和 asset players 放到工作线程进行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 需要同时设置Project Setting中的Allow Multi Threaded Animation Update&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint8 bUseMultiThreadedAnimationUpdate </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FAnimInstanceProxy</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> AnimInstanceProxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>帮助UAnimInstance实现动画系统的功能，主要是操作，管理动画节点，管理动画节点的各个虚函数调用，以及动画通知的处理，清理收集动画通知，然后把收集到的动画通知交给UAnimInstance去处理
FAnimInstanceProxy</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// output pose node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAnimNode_Base</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> RootNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// linked instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAnimNode_LinkedInputPose</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> DefaultLinkedInstanceInputNode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 当前帧被触发的Anim Notify</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FAnimNotifyEventReference</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ActiveAnimNotifiesSinceLastTick</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 在gamethread上执行的UAnimInstance::PreUpdateAnimation节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TArray</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">FAnimNode_Base</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> GameThreadPreUpdateNodes</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FAnimNode_Base是动画节点的基类，在自定义节点的时候常常需要重写一些虚函数</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FAnimNode_Base</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENGINE_API </span><span class="token keyword" style="color:#00009f">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Initialize_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FAnimationInitializeContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENGINE_API </span><span class="token keyword" style="color:#00009f">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CacheBones_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FAnimationCacheBonesContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENGINE_API </span><span class="token keyword" style="color:#00009f">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Update_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FAnimationUpdateContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENGINE_API </span><span class="token keyword" style="color:#00009f">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Evaluate_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FPoseContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ENGINE_API </span><span class="token keyword" style="color:#00009f">virtual</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">EvaluateComponentSpace_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FComponentSpacePoseContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="动画蓝图">动画蓝图<a href="#动画蓝图" class="hash-link" aria-label="Direct link to 动画蓝图" title="Direct link to 动画蓝图">​</a></h2><p>动画蓝图的C++父类是AnimInstance，每一个Character将会拥有一个AnimInstance实例，从AnimInstance实例中也可以获取当前使用自己的Character，这样好处就是把动画相关的逻辑，拆分到AnimInstance去做了，使Character不会过于复杂庞大</p><p>动画蓝图（AnimInstanceProxy）中的所有节点以树状结构组织，它的第一个节点一定是FAnimNode_Root，初始化时将它赋值给RootNode。 RootNode虽然存放在数组中第一个，但却是动画蓝图的输出节点(Output Pose)，其他节点都以输出逆序的方式通过FPoseLink(在蓝图编辑器中表现为有Pose连线)链接成一颗树，执行时采用前序递归遍历。 所有节点大致分为：</p><ol><li>资源播放器(继承自FAnimNode_AssetPlayerBase)，直接输出动画资源。</li><li>混合类节点(FAnimNode_.<em>Blend.</em>)负责确认具体的混合方式与动画结果。</li><li>动画状态和状态机。</li><li>其他功能节点。
对于所有节点来说，具体依赖的参数的计算在函数Update_AnyThread中确定(Time, Weight)，依赖的DeltaTime和动画实例等参数在FAnimationUpdateContext中传递。然后在函数Evaluate_AnyThread中求解，结果保存在FPoseContext中，语义是到当前这个节点时，应该输出怎样的动画姿势、曲线、属性等。</li></ol><p>总的来说，UE的动画系统是把所有操作都抽象成对Pose的处理，每个操作都是确定如何输出当前角色的Pose。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="动画蓝图执行流程">动画蓝图执行流程<a href="#动画蓝图执行流程" class="hash-link" aria-label="Direct link to 动画蓝图执行流程" title="Direct link to 动画蓝图执行流程">​</a></h3><p><em>总结</em>
动画蓝图就是为了混合各个Pose，输出最终的Pose，最终的OutputPose是AnimGraph的Root，每次Tick，会先对EventGraph进行Tick，然后从Root开始DFS遍历两次AnimGraph Tree</p><ol><li>执行每个Node的Update_AnyThread,通过传入父节点的FAnimUpdateContext，计算当前节点的weight【用于AnimationInsight、PoseWatch等】</li><li>执行每个Node的Evaluate_AnyThread, 父节点用子节点Pose更新自己的Pose，传递通过FPoseContext</li></ol><p>以PSD为例，该Node接受一个输入Pose，对骨骼Transform进行后处理。根据读取的Config，找到Skeleton里的所有Driver Bone，每个Driver Bone对应一个PSD，每个PSD可以有多个DrivenBone，记录k个sample，每个sample包括DriverBone的Rot和DrivenBone的Transform。首先需要调用Solver计算出，当前Pose下（输入的Pose）每个Sample的权重，然后把每个DrivenBone的Transform更新为Sample的混合</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">FAnimNode_XPoseDriver</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Update_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FAnimationUpdateContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Super</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Update_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//EvaluateGraphExposedInputs.Execute(Context);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InputPose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">FAnimNode_XPoseDriver</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Evaluate_AnyThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FPoseContext</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FPoseContext </span><span class="token function" style="color:#d73a49">dupContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InputPose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Evaluate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dupContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the index of the source bone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FBoneContainer</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> BoneContainer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dupContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBoneContainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DriverBoneTMs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FBoneReference</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> driverBone </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DriverBones</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FTransform DriverBoneTM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FTransform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Identity</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FCompactPoseBoneIndex SourceCompactIndex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driverBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetCompactPoseIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BoneContainer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SourceCompactIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> INDEX_NONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DriverBoneTM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dupContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SourceCompactIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DriverBoneTMs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driverBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BoneName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DriverBoneTM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//blend process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> elem </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> BoneToPSDTable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> boneName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> psdNames </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> tm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DriverBoneTMs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">boneName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> psdName </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> psdNames</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> psd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PSDWorkers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">psdName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            psd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">Resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// solver 解算</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> currentPsdDescription </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> psd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_desc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//blend driven joints TRS for skeleton psd.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentPsdDescription</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PsdSolverNodeType </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xSolver&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> drivenBoneName </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> currentPsdDescription</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DrivenObjects</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> drivenBone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DrivenBones</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">drivenBoneName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    FTransform DrivenBoneTM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FTransform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Identity</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> FCompactPoseBoneIndex SourceCompactIndex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> drivenBone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetCompactPoseIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BoneContainer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SourceCompactIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> INDEX_NONE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        DrivenBoneTM </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dupContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SourceCompactIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FTransform</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> TargetTransform </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pose</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SourceCompactIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector lOriginalTranslate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DrivenBoneTM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTranslation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector lOriginalAngle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DrivenBoneTM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Euler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FQuat lOriginalQ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DrivenBoneTM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector lOriginalScale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DrivenBoneTM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetScale3D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">//the number of weights must be same as the number of poses.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> weightsNum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> psd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">Weights</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> posesNum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentPsdDescription</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Poses</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Num</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lAllWeights </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector </span><span class="token function" style="color:#d73a49">lT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector </span><span class="token function" style="color:#d73a49">lR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FVector </span><span class="token function" style="color:#d73a49">lS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string DebugWeights</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> elem2 </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> psd</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">Weights</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FString lPoseName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elem2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Key</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lWeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elem2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> lPose </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentPsdDescription</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Poses</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lPoseName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> lDrivenMatrix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lPose</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">outDrivenLocalMatrixList</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">drivenBoneName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FMatrix</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> lMatrix </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lDrivenMatrix</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FTransform </span><span class="token function" style="color:#d73a49">lDrivenTransform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lMatrix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FVector translation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lDrivenTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTranslation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FVector angles </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lDrivenTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Euler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            FVector scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lDrivenTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetScale3D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angles</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angles</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">angles</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">*=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">*=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lS</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lWeight </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lAllWeights </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> lWeight</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">//convert Maya translate to UE translate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TargetTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTranslation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">FVector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lRx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lRy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lRz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> lJointOrient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> currentPsdDescription</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DrivenJointOrientList</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">drivenBoneName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lOx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lJointOrient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lOy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lJointOrient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> lOz </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lJointOrient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FRotator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lOy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lOz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lOx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FRotator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lR</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FQuat jointOrientQ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FQuat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FQuat jointRotateQ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FQuat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FQuat lRotateQ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain">  jointOrientQ </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> jointRotateQ</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">lRotateQ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsNormalized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            lRotateQ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Normalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TargetTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetRotation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lRotateQ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TargetTransform</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetScale3D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// if SourceCompactIndex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//for drivenBoneName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// if xSolver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// for psdName</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// for elem</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试用例
<img loading="lazy" alt="alt text" src="/assets/images/image-7-13c49d7cba9f982502c64ebfaba12ba7.png" width="1315" height="490" class="img_ev3q">
rewind中可以查看到三段sequence的blend比例分别为walk_fwd = 0.5，jump = 0.5，equip = 0.25
<img loading="lazy" alt="alt text" src="/assets/images/image-8-f9044145e74c964c406736dc9650bd77.png" width="964" height="455" class="img_ev3q">
<img loading="lazy" alt="alt text" src="/assets/images/image-9-b63eeed974e1532757f16eeb42fc923e.png" width="1241" height="495" class="img_ev3q"></p><p><a href="https://app.diagrams.net/#G1EZSfyheX2nfUPK2aAwKCHdAC8rQk3T74#%7B%22pageId%22%3A%22IAjTh5yaLsgbAQ9wG9K3%22%7D" target="_blank" rel="noopener noreferrer">流程图</a>
<img loading="lazy" alt="alt text" src="/assets/images/rewind-19d308a96e5882c389c9bc326e166ff2.jpg" width="961" height="1327" class="img_ev3q">
UAnimInstance::PreUpdateAnimation会调用FAnimInstanceProxy的函数<code>GetProxyOnGameThread&lt;FAnimInstanceProxy&gt;().PreUpdate(this, DeltaSeconds);</code>,其中会执行</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FAnimNode_Base</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Node </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> GameThreadPreUpdateNodes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Node</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">PreUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">InAnimInstance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>UAnimInstance::ParallelUpdateAnimation会调用<code>GetProxyOnAnyThread&lt;FAnimInstanceProxy&gt;().UpdateAnimation();</code>
注意绿框中的部分，在ABP预览状态时会执行，但在runtime一般不会执行，而是留到<code>USkeletalMeshComponent::RefreshBoneTransform</code>中,分发到工作线程执行。</p><p>FAnimInstanceProxy::ParallelUpdate是动画AnimGraph执行的核心部分</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">FAnimInstanceProxy</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">UpdateAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 首先对root（outputpose）执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UpdateAnimation_WithRoot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RootNode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NAME_AnimGraph</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 线程安全更新函数（native和蓝图中定义的）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// UAnimInstance::NativeThreadSafeUpdateAnimation一般会在自己继承AnimInstance的cpp类中overwrite</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">NativeThreadSafeUpdateAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">BlueprintThreadSafeUpdateAnimation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>FAnimNode_Base::Update_AnyThread</code>会从root进去遍历每个node执行，通过FPoseLinkBase找到链接到当前node的子节点（树的子节点，其实是animgraph的上游节点）。具体实现在<code>FPoseLinkBase::Update</code>中
<img loading="lazy" alt="alt text" src="/assets/images/image-27-04eabe573494f3d37b6a44b5a0312452.png" width="998" height="588" class="img_ev3q"></p><p>然后Evaluate_AnyThread也是类似的操作。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分发到工作线程的方式">分发到工作线程的方式<a href="#分发到工作线程的方式" class="hash-link" aria-label="Direct link to 分发到工作线程的方式" title="Direct link to 分发到工作线程的方式">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="举例几个animnode">举例几个AnimNode<a href="#举例几个animnode" class="hash-link" aria-label="Direct link to 举例几个AnimNode" title="Direct link to 举例几个AnimNode">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fanimnode_twoboneik">FAnimNode_TwoBoneIK<a href="#fanimnode_twoboneik" class="hash-link" aria-label="Direct link to FAnimNode_TwoBoneIK" title="Direct link to FAnimNode_TwoBoneIK">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fanimnode_sequenceplayer">FAnimNode_SequencePlayer<a href="#fanimnode_sequenceplayer" class="hash-link" aria-label="Direct link to FAnimNode_SequencePlayer" title="Direct link to FAnimNode_SequencePlayer">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="自定义-fanimnode_psd">自定义 FAnimNode_PSD<a href="#自定义-fanimnode_psd" class="hash-link" aria-label="Direct link to 自定义 FAnimNode_PSD" title="Direct link to 自定义 FAnimNode_PSD">​</a></h4><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fast-path">Fast Path<a href="#fast-path" class="hash-link" aria-label="Direct link to Fast Path" title="Direct link to Fast Path">​</a></h3><p>下图中1、2均支持Fast Path， 官方文档写着：读成员变量、对结构体成员变量进行break操作以及Bool Not操作依然支持Fast Path，而其他数值运算不支持Fast Path（图三）。
<img loading="lazy" alt="alt text" src="/assets/images/image-10-f0247ca83c5ae8a2d596fdc198abe1ca.png" width="1020" height="371" class="img_ev3q">
<img loading="lazy" alt="alt text" src="/assets/images/image-11-85e64c85811ee2f6433e1b847ded96dd.png" width="988" height="402" class="img_ev3q">
<img loading="lazy" alt="alt text" src="/assets/images/image-12-d1e49cfc7c3acda8401f834396603651.png" width="1050" height="459" class="img_ev3q"></p><p><strong>什么是Fast Path</strong>
使用FastPath，引擎就可以在内部复制参数，而不是执行蓝图代码，后者需要调用蓝图虚拟机在runtime对编译的蓝图字节码进行解释，测速验证结果如下。
<img loading="lazy" alt="alt text" src="/assets/images/image-14-2d3fc5d573918bbf3cf2891795efe72a.png" width="1592" height="562" class="img_ev3q">
<img loading="lazy" alt="alt text" src="/assets/images/image-15-be7a0ddb457c5b1cb227c0fc315b2ebd.png" width="1232" height="593" class="img_ev3q">
<img loading="lazy" alt="alt text" src="/assets/images/image-13-9c1bb5c6eb2d1d13d385857d18ff5ba5.png" width="1544" height="562" class="img_ev3q"></p><ul><li>graph-1  13 + 47</li><li>graph-2  13 + 52</li><li>graph-3  13 + 61</li></ul><h1>Reference</h1><ul><li><a href="https://docs.cocos.com/creator/3.8/manual/en/animation/marionette/additive-animation/" target="_blank" rel="noopener noreferrer">addtive动画 cocos</a></li><li><a href="https://docs.unrealengine.com/4.27/en-US/AnimatingObjects/SkeletalMeshAnimation/AimOffset/" target="_blank" rel="noopener noreferrer">addtive动画 博客</a></li><li><a href="https://docs.unrealengine.com/4.27/en-US/AnimatingObjects/SkeletalMeshAnimation/AimOffset/" target="_blank" rel="noopener noreferrer">addtive动画 UE4</a></li><li><a href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/animation-optimization-in-unreal-engine" target="_blank" rel="noopener noreferrer">UE5官方文档 动画优化</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ue">UE</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/Unreal/UE动画模块浅析/1.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/Unreal/Lyra浅析/1"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Lyra浅析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/Unreal/UE类型系统/1"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">UE类型系统</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#动画融合方式" class="table-of-contents__link toc-highlight">动画融合方式</a><ul><li><a href="#传统动画融合" class="table-of-contents__link toc-highlight">传统动画融合</a></li><li><a href="#惯性融合inertialization" class="table-of-contents__link toc-highlight">惯性融合Inertialization</a></li></ul></li><li><a href="#additive动画" class="table-of-contents__link toc-highlight">Additive动画</a></li><li><a href="#animation-montage" class="table-of-contents__link toc-highlight">Animation Montage</a></li><li><a href="#重定向" class="table-of-contents__link toc-highlight">重定向</a></li><li><a href="#资产类" class="table-of-contents__link toc-highlight">资产类</a><ul><li><a href="#导入过程" class="table-of-contents__link toc-highlight">导入过程</a></li><li><a href="#uskeleton" class="table-of-contents__link toc-highlight">USkeleton</a></li><li><a href="#skeletalmesh" class="table-of-contents__link toc-highlight">SkeletalMesh</a></li><li><a href="#uanimationsequence" class="table-of-contents__link toc-highlight">UAnimationSequence</a></li></ul></li><li><a href="#uaniminstance和faniminstanceproxy" class="table-of-contents__link toc-highlight">UAnimInstance和FAnimInstanceProxy</a></li><li><a href="#动画蓝图" class="table-of-contents__link toc-highlight">动画蓝图</a><ul><li><a href="#动画蓝图执行流程" class="table-of-contents__link toc-highlight">动画蓝图执行流程</a></li><li><a href="#分发到工作线程的方式" class="table-of-contents__link toc-highlight">分发到工作线程的方式</a></li><li><a href="#举例几个animnode" class="table-of-contents__link toc-highlight">举例几个AnimNode</a></li><li><a href="#fast-path" class="table-of-contents__link toc-highlight">Fast Path</a></li></ul></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.aa064b75.js"></script>
<script src="/assets/js/main.bbe150d2.js"></script>
</body>
</html>